[{"name":"AC-Baidu：绕过百度重定向直接访问网页","namespace":"1353464539@qq.com","includes":["http://www.baidu.com/*","https://www.baidu.com/*","http://www.sogou.com/*","https://www.sogou.com/*"],"excludes":[],"matches":[],"requires":[],"enabled":true,"jscode":"// ==UserScript==\n// @name AC-Baidu：绕过百度重定向直接访问网页\n// @author         AC\n// @namespace      1353464539@qq.com\n// @description    繞過百度搜索結果中的自己的跳轉鏈接，直接訪問原始網頁-反正都能看懂\n// @version        6.7\n// @create         2015-11-25\n// @lastmodified   2016-10-27\n// @include        http://www.baidu.com/*\n// @include        https://www.baidu.com/*\n// @include        http://www.sogou.com/*\n// @include        https://www.sogou.com/*\n// @copyright      2015+, AC\n// @run-at         document-end\n// @grant\t\t    GM_xmlhttpRequest\n// @icon            https://coding.net/u/zb227/p/zbImg/git/raw/master/img0/icon.jpg\n// @note            2016.10.27-V6.7 修复了以前的重复请求，现在的请求数应该小了很多，网络也就不卡了，感觉萌萌哒\n// @note            2016.4.24-V6.6 恢复以前的版本，因为兼容性问题\n// @note            2015.12.1-V5.0 加入搜狗的支持，但是支出不是很好\n// @note            2015.11.25-V2.0 优化，已经是真实地址的不再尝试获取\n// @connect *\n// @note            2015.11.25-V1.0 完成去掉百度重定向的功能 \n// ==/UserScript==\n\n// 采用MutationObserver监视会大大实际代码的调用次数-比DOMNodeInserted更好的调用方式\n\nvar targets;\nvar list;\nvar time;\nvar Stype;\ntargets = document.body; // 百度\nmo = new MutationObserver(function(allmutations) {\n    // 注意querySelectorAll得到的对象是静态的，所以每次重复调用的时候需要更新\n    time = new Date().getTime();\n    if(location.href.indexOf(\"baidu.com\") > -1)\n        Stype = \".t a[href='\";\n    else if(location.href.indexOf(\"sogou.com\") > -1)\n        Stype = \".rb .pt a[href='\";\n    list = document.querySelectorAll(Stype.substring(0,Stype.length-7));\n    resetURL();\n});\nmo.observe(targets, {'childList': true, 'subtree': true});\nfunction resetURL(){\n    for(var i = 0; i < list.length; i++){\n        // 此方法是异步，故在结束的时候使用i会出问题-严重!\n        // 采用调用前通过context过去，调用结束后通过response.context获得\n        var curhref = list[i].href;\n        if(list[i].getAttribute(\"loaded_Status\") == null){\n            list[i].setAttribute(\"loaded_Status\", \"0\");\n            if(curhref.indexOf(\"baidu.com\") > -1 || curhref.indexOf(\"sogou.com\") > -1){\n                GM_xmlhttpRequest({\n                        url: curhref,\n                        headers: {\n                            \"Accept\": \"text/html\"\n                        },\n                        context: curhref, //直接传递i,在i=0的时候反馈回来时null-猜想被会被转换掉，所以+1\n                        method: \"GET\",\n                        onload: function(response) {\n                        },\n                        onreadystatechange:function(response) {\n                            if(response.readyState==4||response.status==0){\n                                var indexhref = response.context;\n                                var ccnode = document.querySelectorAll(Stype+indexhref+\"']\")[0];\n                                //console.log(ccnode.href);\n                                if(ccnode != null){\n                                    ccnode.href = response.finalUrl;\n                                }else{\n                                    console.log(\"该链接已经被其他脚本干掉了哦\"+response.finalUrl);\n                                }\n                            }\n                            //console.log(response);\n                        }\n                });\n            }else{\n                console.log(\"绕过百度重定向直接访问网页： 第\"+i+\"个已经处理了\");\n            }\n        }\n    }\n}"}]
